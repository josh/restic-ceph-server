tail-logs
create-pool

exec restic-rados-server --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/' --output response1.txt
stdout '400'
grep 'missing required query parameter: create' response1.txt

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=false' --output response2.txt
stdout '400'
grep 'invalid value for create parameter' response2.txt

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=1' --output response3.txt
stdout '400'
grep 'invalid value for create parameter' response3.txt

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=True' --output response4.txt
stdout '400'
grep 'invalid value for create parameter' response4.txt

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=yes' --output response5.txt
stdout '400'
grep 'invalid value for create parameter' response5.txt

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=' --output response6.txt
stdout '400'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true' --output /dev/null
stdout '200'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true' --output /dev/null
stdout '200'

exec curl --silent --unix-socket $WORK/restic.sock --request POST --data-binary @config-data 'http://localhost/config'
exec curl --silent --unix-socket $WORK/restic.sock --request GET 'http://localhost/config'
cmp stdout config-data

kill server

-- config-data --
{"version":2,"id":"test","chunker_polynomial":"25b468838dcb75ea"}
