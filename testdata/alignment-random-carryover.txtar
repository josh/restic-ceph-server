tail-logs
create-pool

exec restic-rados-server --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

bin-file rand random-carryover 16777316
sha256 random-carryover HASH

exec curl --silent --unix-socket $WORK/restic.sock --request POST --header 'Content-Type: application/octet-stream' --data-binary @random-carryover http://localhost/data/$HASH

exec curl --silent --unix-socket $WORK/restic.sock --head --include http://localhost/data/$HASH
stdout 'HTTP/.* 200'
stdout 'Content-Length: 16777316'

exec curl --silent --unix-socket $WORK/restic.sock http://localhost/data/$HASH --output downloaded
bin-cmp downloaded random-carryover

kill server
