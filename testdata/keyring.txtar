tail-server-log
create-pool

exec restic-ceph-server --keyring $WORK/dummy.keyring --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

exec curl --silent --unix-socket $WORK/restic.sock --request POST --header 'Content-Type: application/octet-stream' --data-binary @config-data http://localhost/config

exec curl --silent --unix-socket $WORK/restic.sock --request GET http://localhost/config
cmp stdout config-data

kill server

exec restic-ceph-server --id backup --listen $WORK/restic2.sock &server2&
wait4socket $WORK/restic2.sock

exec curl --silent --unix-socket $WORK/restic2.sock --request POST 'http://localhost/?create=true'

exec curl --silent --unix-socket $WORK/restic2.sock --request GET http://localhost/config
cmp stdout config-data

kill server2

env CEPH_KEYRING=$WORK/dummy.keyring
exec restic-ceph-server --listen $WORK/restic3.sock &server3&
wait4socket $WORK/restic3.sock

exec curl --silent --unix-socket $WORK/restic3.sock --request GET http://localhost/config
cmp stdout config-data

kill server3

env CEPH_ID=backup2
env CEPH_KEYRING=
exec restic-ceph-server --listen $WORK/restic4.sock &server4&
wait4socket $WORK/restic4.sock

exec curl --silent --unix-socket $WORK/restic4.sock --request GET http://localhost/config
cmp stdout config-data

kill server4

-- config-data --
{"version":2,"id":"test","chunker_polynomial":"25b468838dcb75ea"}

-- dummy.keyring --
[client.backup]
	key = AQDummyKeyForTestingOnly==
