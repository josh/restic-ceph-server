tail-logs
create-pool

exec restic-rados-server --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

bin-file zeros buffer-exact 16777216

exec curl --silent --unix-socket $WORK/restic.sock --request POST --header 'Content-Type: application/octet-stream' --data-binary @buffer-exact 'http://localhost/data/080acf35a507ac9849cfcba47dc2ad83e01b75663a516279c8b9d243b719643e'

exec curl --silent --unix-socket $WORK/restic.sock --head --include 'http://localhost/data/080acf35a507ac9849cfcba47dc2ad83e01b75663a516279c8b9d243b719643e'
stdout 'HTTP/.* 200'
stdout 'Content-Length: 16777216'

exec curl --silent --unix-socket $WORK/restic.sock 'http://localhost/data/080acf35a507ac9849cfcba47dc2ad83e01b75663a516279c8b9d243b719643e' --output downloaded
bin-cmp downloaded buffer-exact

exec rados --pool $CEPH_POOL ls
stdout 'data/080acf35a507ac9849cfcba47dc2ad83e01b75663a516279c8b9d243b719643e'

kill server
