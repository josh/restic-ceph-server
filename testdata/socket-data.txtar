exec tail-server-log &

exec restic-ceph-server --listen $WORK/restic.sock &server&
exec wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

exec curl --silent --unix-socket $WORK/restic.sock --request POST --data-binary @blob-data 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a'

exec curl --silent --unix-socket $WORK/restic.sock --head --include 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a'
stdout 'HTTP.* 200'
stdout 'Content-Length: 18'

exec curl --silent --unix-socket $WORK/restic.sock --request GET 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a'
cmp stdout blob-data

exec curl --silent --unix-socket $WORK/restic.sock --request GET 'http://localhost/data/'
stdout 'abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request DELETE 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a' --output /dev/null
stdout '200'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request DELETE 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a' --output /dev/null
stdout '200'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request GET 'http://localhost/data/abd9a2bf47af3416b041796843b9f9a7a5e987356da7ccfc750816219f0a075a' --output /dev/null
stdout '404'

kill server

-- blob-data --
test blob content
