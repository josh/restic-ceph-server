tail-logs
create-pool

exec restic-rados-server --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

bin-file zeros buffer-plus-small 16777316

exec curl --silent --unix-socket $WORK/restic.sock --request POST --header 'Content-Type: application/octet-stream' --data-binary @buffer-plus-small 'http://localhost/data/1d8ac2fe04dccff30b99758721c84eb12c6d5b383a46b81f722be8fcf7ad5725'

exec curl --silent --unix-socket $WORK/restic.sock --head --include 'http://localhost/data/1d8ac2fe04dccff30b99758721c84eb12c6d5b383a46b81f722be8fcf7ad5725'
stdout 'HTTP/.* 200'
stdout 'Content-Length: 16777316'

exec curl --silent --unix-socket $WORK/restic.sock 'http://localhost/data/1d8ac2fe04dccff30b99758721c84eb12c6d5b383a46b81f722be8fcf7ad5725' --output downloaded
bin-cmp downloaded buffer-plus-small

exec rados --pool $CEPH_POOL ls
stdout 'data/1d8ac2fe04dccff30b99758721c84eb12c6d5b383a46b81f722be8fcf7ad5725'

kill server
