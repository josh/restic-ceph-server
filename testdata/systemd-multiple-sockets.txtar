exec tail-server-log &

exec systemd-socket-activate --setenv=CEPH_POOL --setenv=CEPH_CONF --listen=127.0.0.1:$PORT --listen=$WORK/restic.sock restic-ceph-server --verbose --log-file=$RESTIC_CEPH_SERVER_LOG_FILE &server&
wait4socket 127.0.0.1:$PORT $WORK/restic.sock

exec curl --silent --request POST http://127.0.0.1:$PORT/?create=true

exec curl --silent --request POST --header 'Content-Type: application/octet-stream' --data-binary @config-data http://127.0.0.1:$PORT/config

exec curl --silent --request GET http://127.0.0.1:$PORT/config
cmp stdout config-data

exec curl --silent --unix-socket $WORK/restic.sock --request GET http://localhost/config
cmp stdout config-data

exec curl --silent --head --include http://127.0.0.1:$PORT/config
stdout 'HTTP/.* 200'
stdout 'Content-Length: 66'

exec curl --silent --unix-socket $WORK/restic.sock --head --include http://localhost/config
stdout 'HTTP/.* 200'
stdout 'Content-Length: 66'

kill server

-- config-data --
{"version":2,"id":"test","chunker_polynomial":"25b468838dcb75ea"}
