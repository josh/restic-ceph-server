tail-logs
create-pool

bin-file zeros large-blob 40000000

exec rados --striper --conf $CEPH_CONF --pool $CEPH_POOL put data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562 large-blob

exec rados --conf $CEPH_CONF --pool $CEPH_POOL ls
stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000000'
stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000001'

exec rados --conf $CEPH_CONF --pool $CEPH_POOL rm data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562.0000000000000003

exec rados --conf $CEPH_CONF --pool $CEPH_POOL ls
stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000000'
! stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000003'

exec restic-ceph-server --listen $WORK/restic.sock --enable-striper &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

exec curl --silent --write-out '%{http_code}' --unix-socket $WORK/restic.sock --request POST --data-binary @large-blob http://localhost/data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562 --output /dev/null
stdout '403'

exec rados --conf $CEPH_CONF --pool $CEPH_POOL ls
stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000000'
! stdout 'data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562\.0000000000000003'

exec curl --silent --unix-socket $WORK/restic.sock --request GET http://localhost/data/c0e6623abfbed73c146be81338cff1e8e4c06dd05eb98721163dc79fbbd20562 --output downloaded-blob
bin-cmp downloaded-blob large-blob

kill server
