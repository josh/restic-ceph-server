tail-logs
create-pool

exec restic-rados-server --listen $WORK/restic.sock &server&
wait4socket $WORK/restic.sock

exec curl --silent --unix-socket $WORK/restic.sock --request POST 'http://localhost/?create=true'

bin-file rand tiny-file 100
sha256 tiny-file HASH

exec curl --silent --unix-socket $WORK/restic.sock --request POST --header 'Content-Type: application/octet-stream' --data-binary @tiny-file http://localhost/data/$HASH

exec curl --silent --unix-socket $WORK/restic.sock --head --include http://localhost/data/$HASH
stdout 'HTTP/.* 200'
stdout 'Content-Length: 100'

exec curl --silent --unix-socket $WORK/restic.sock http://localhost/data/$HASH --output downloaded
bin-cmp downloaded tiny-file

kill server
