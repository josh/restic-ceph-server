tail-server-log

exec restic init --option rclone.program=restic-ceph-server --repo rclone: --password-file password.txt

mkdir data
bin-file rand data/blob0.bin 16384
bin-file rand data/blob1.bin 16384
bin-file rand data/blob2.bin 16384
bin-file rand data/blob3.bin 16384
bin-file rand data/blob4.bin 16384
bin-file rand data/blob5.bin 16384
bin-file rand data/blob6.bin 16384
bin-file rand data/blob7.bin 16384

exec restic backup data --option rclone.program=restic-ceph-server --repo rclone: --password-file password.txt

exec restic check --json --read-data-subset=1/1 --option rclone.program=restic-ceph-server --repo rclone: --password-file password.txt
stdin stdout
exec jq --slurp --from-file expr.jq
cmp stdout check.json

-- password.txt --
secret
-- expr.jq --
{
  error_messages: (map(select(.message_type == "error")) | length),
  summary: (
    map(select(.message_type == "summary"))
    | if length == 0 then error("missing summary message") else .[0] end
    | {
      num_errors,
      broken_packs,
      suggest_repair_index,
      suggest_prune
    }
  )
}
-- check.json --
{
  "error_messages": 0,
  "summary": {
    "num_errors": 0,
    "broken_packs": null,
    "suggest_repair_index": false,
    "suggest_prune": false
  }
}
